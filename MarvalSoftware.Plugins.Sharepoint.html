
<script type="text/javascript" src="template.js"></script>
<template>
    <style>
        /*        #groupsDropdown {
                    font-weight: normal;
                }*/
        .container {
            max-width: 1024px;
            margin: 0 auto;
        }
        .note-item {
            padding: 8px;
            border-bottom: 1px solid #ccc;
            font-family: Arial, sans-serif;
        }
/*        #attachmentsDiv{
            display:flex;
        }*/
        #itemsDiv{
            display:flex !important;
            
        }

        #notesDiv,
        #attachmentsDiv, #emailsDiv {
            flex: 1; /* Make them grow equally */
            min-width: 0; /* Prevent overflow if needed */
            border: 1px solid #ccc; /* Optional: visual separation */
            padding: 8px;
            box-sizing: border-box;
        }

        .note-item input[type="checkbox"] {
            margin-right: 8px;
        }

        .folder-tree {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        .folder-icon.selected,
.folder-icon.selected path {
    fill: #22c55e !important;
}
        .header {
            border-bottom: 1px solid #e5e7eb;
            padding: 16px;
        }

            .header h2 {
                font-size: 18px;
                font-weight: 600;
                color: #374151;
                margin-bottom: 4px;
            }

            .header p {
                font-size: 14px;
                color: #6b7280 !important;
            }

        .tree-content {
            height: 300px;
            padding: 16px;
            overflow: auto;
        }

        .tree-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 2px 2px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            user-select: none;
        }

            .tree-item:hover {
                background-color: #f9fafb;
            }

            .tree-item.hovered {
                background-color: #eff6ff;
            }

                .tree-item.hovered:hover {
                    background-color: #dbeafe;
                }

        .tree-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .expand-button2 {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
            padding:0;
        }

            .expand-button2:hover {
                background-color: #e5e7eb;
            }

        .chevron {
            width: 16px !important;
            height: 16px !important;
            fill: #6b7280 !important;
            transition: transform 0.2s !important;
        }

            .chevron.expanded {
                transform: rotate(90deg);
            }

        .folder-icon {
            width: 20px;
            height: 20px;
            fill: #2563eb;
        }

        .folder-name {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
            flex: 1;
        }

        .item-count {
            font-size: 12px !important;
            color: #6b7280 !important;
            background-color: #f3f4f6 !important;
            padding: 2px 8px !important;
            border-radius: 12px !important;
            margin-left: 8px !important;
        }

        .last-modified {
            font-size: 12px;
            color: #9ca3af;
            margin-left: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .children {
            margin-left: 20px;
        }

        .notes {
            margin-top: 24px;
            padding: 16px;
            background-color: #f9fafb;
            border-radius: 8px;
        }

            .notes h3 {
                font-weight: 500;
                color: #374151;
                margin-bottom: 8px;
            }

            .notes ul {
                list-style: none;
                font-size: 14px;
                color: #6b7280 !important;
            }

            .notes li {
                margin-bottom: 4px;
                padding-left: 8px;
            }

                .notes li::before {
                    content: "• ";
                    margin-right: 4px;
                }

            .notes code {
                background-color: #f3f4f6;
                padding: 2px 4px;
                border-radius: 4px;
                font-family: 'Courier New', monospace;
            }



        .content {
            border-radius: 10px;
            font-family: 'Inter', 'Open Sans', sans-serif;
            font-weight: bold;
            /*            height:500px !important;*/
        }

        #uploadAll {
            cursor: pointer;
        }

        .messageButton {
            background-color: #8c9097;
            font-weight: normal;
            cursor: pointer;
        }

        #uploadFile {
            cursor: pointer;
        }

        #createFolder {
            cursor: pointer;
        }

        .LinkedProjectsHeader {
            /* background: linear-gradient(to bottom right,#cbd6e2,#cbd6e2) !important;  */
            color: #00314a !important;
            font-size: 12px !important;
            font-family: 'Inter', 'Open Sans', sans-serif;
        }

            .LinkedProjectsHeader h1 {
                /* background: linear-gradient(to bottom right,#cbd6e2,#cbd6e2) !important;  */
                color: #00314a !important;
                font-size: 12px !important;
                font-family: 'Inter', 'Open Sans', sans-serif;
            }

        .headerColourChange {
            background: linear-gradient(to bottom right, #cbd6e2, #cbd6e2) !important;
            color: #00314a !important;
            font-size: 18px !important;
            font-family: 'Inter', 'Open Sans', sans-serif;
            border-radius: 10px;
        }

        .itemsTable {
            display: flex;
        }

        #message {
            vertical-align: top;
            /*            height: 100px;*/
            width: 600px;
        }

        marvalsoftware-plugins-sharepoint {
            /*            display: block;*/
            height: 200px;
        }

            /*            marvalsoftware-plugins-sharepoint > .config-area {
                        height: 100px;
                        padding: 0px 10px 10px 10px;
                        box-shadow: 0 1px 0 0 #ebe8e4;
                    }

                        marvalsoftware-plugins-sharepoint > .config-area > div {
                            padding: 10px 0 0 0;
                        }
        */
            marvalsoftware-plugins-sharepoint > .message-area {
                /*                display: block;*/
                height: 100px;
                padding: 10px;
                box-shadow: 0 1px 0 0 #ebe8e4;
            }

                marvalsoftware-plugins-sharepoint > .message-area > .cards {
                    height:;
                    overflow-y: auto;
                    padding: 10px;
                    box-shadow: 0 1px 0 0 #ebe8e4;
                }

                    marvalsoftware-plugins-sharepoint > .message-area > .cards .card {
                        background-color: #fff;
                        padding: 1.5rem;
                        margin-bottom: 0.5rem;
                        border: 1px solid #ebe8e4;
                        border-radius: 4px;
                        box-shadow: 0 1px 1px 0 #ebe8e4;
                    }

                        marvalsoftware-plugins-sharepoint > .message-area > .cards .card .timestamp {
                            font-size: 0.75rem;
                            font-weight: 500;
                            color: #666;
                            width: 10%;
                        }

                        marvalsoftware-plugins-sharepoint > .message-area > .cards .card .tooltip {
                            position: relative;
                            /*                            display: inline-block;*/
                        }

                            marvalsoftware-plugins-sharepoint > .message-area > .cards .card .tooltip .tooltiptext {
                                visibility: hidden;
                                width: 120px;
                                background-color: #555;
/*                                color: #fff;*/
                                text-align: center;
                                border-radius: 6px;
                                padding: 5px 0;
                                position: absolute;
                                z-index: 1;
                                bottom: 125%;
                                left: 50%;
                                margin-left: -60px;
                                opacity: 0;
                                transition: opacity 0.3s;
                            }

                                marvalsoftware-plugins-sharepoint > .message-area > .cards .card .tooltip .tooltiptext::after {
                                    content: "";
                                    position: absolute;
                                    top: 100%;
                                    left: 50%;
                                    margin-left: -5px;
                                    border-width: 5px;
                                    border-style: solid;
                                    border-color: #555 transparent transparent transparent;
                                }

                            marvalsoftware-plugins-sharepoint > .message-area > .cards .card .tooltip:hover .tooltiptext {
                                visibility: visible;
                                opacity: 1;
                            }

                        marvalsoftware-plugins-sharepoint > .message-area > .cards .card .status {
                            margin-top: 0.75rem;
                            font-size: 1rem;
                            font-weight: 600;
                        }

                        marvalsoftware-plugins-sharepoint > .message-area > .cards .card .message {
                            line-height: 22px;
                            margin-right: 6rem;
                            color: #666;
                            font-size: 0.875rem;
                            white-space: pre-line;
                        }

            marvalsoftware-plugins-sharepoint > .update-area {
                height: 20%;
                padding: 10px 10px 0 10px;
            }

                marvalsoftware-plugins-sharepoint > .update-area textarea {
                    width: 100%;
                    height: 75%;
                    box-sizing: border-box;
                    -moz-box-sizing: border-box;
                    -webkit-box-sizing: border-box;
                    resize: none;
                }

                marvalsoftware-plugins-sharepoint > .update-area .action-buttons {
                    float: right;
                    padding-top: 10px;
                }

                    marvalsoftware-plugins-sharepoint > .update-area .action-buttons button {
                        box-sizing: border-box;
                        border: 1px solid #ccc;
                        border-radius: 2px;
                        background-color: #6697EA; /*changing colour from green to blue*/
                        cursor: pointer; /*changing to pointer when cursor is over it*/
                    }

                marvalsoftware-plugins-sharepoint > .update-area label,
                marvalsoftware-plugins-sharepoint > .message-area label,
                marvalsoftware-plugins-sharepoint > .config-area > div label {
                    font-size: 1rem;
                    font-weight: 600;
                    /*                    display: inline-block;*/
                    width: 50px;
                    padding-bottom: 5px;
                }

        .headerColourChange {
            background: linear-gradient(to bottom right, #cbd6e2, #cbd6e2) !important;
            color: #00314a !important;
            font-size: 18px !important;
            font-family: 'Inter', 'Open Sans', sans-serif;
        }

        marvalsoftware-plugins-sharepoint > .message-area label {
            width: 100px !important;
        }

        marvalsoftware-plugins-sharepoint > .message-area > .header {
            align-items: center
        }

            marvalsoftware-plugins-sharepoint > .message-area > .header a img {
                position: relative;
                top: 4px;
            }
    </style>
    <div class="config-area">


    </div>

    <!--<div id="folderTreeWrapper">--> <!--folder tree stuff goes here-->
    <!--<div class="container">
        <div class="folder-tree">
            <div class="header">
                <h2>SharePoint Folders</h2>
                <p>Browse and explore your folder structure</p>
            </div>
            <div class="tree-content" id="treeContent">-->
    <!-- Tree items will be generated here -->
    <!--</div>
        </div>

        <div class="notes">
            <h3>API Integration Notes:</h3>
            <ul>
                <li>Replace the mock <code>fetchChildren</code> function with actual Microsoft Graph API calls</li>
                <li>Add proper error handling and authentication</li>
                <li>Consider implementing virtual scrolling for large folder structures</li>
                <li>Add context menus for folder operations (create, rename, delete, etc.)</li>
                <li>Implement search functionality across the folder structure</li>
            </ul>
        </div>
    </div>-->
    <!--</div>-->
    <div class="container" id="treeContainer" display="none">
        <div class="folder-tree">
            <div class="header">
                <h2>SharePoint Folders</h2>
                <p>Browse and explore your folder structure</p>
            </div>
            <div class="tree-content" id="treeContent" display="none">
                <!-- Tree items will be generated here -->
            </div>
        </div>

    </div>

    <select id="sitesDropdown"><option>Loading!</option></select>
    <!--<select id="foldersDropdown"><option>Still loading!</option></select>-->
    <div id="successMessage">Success Message</div>


    <!--<button id="uploadFile">upload</button>-->
    <button id="createFolder">Create Folder!</button>
    <!--<button id="testButton">test button</button>-->

    <div class="itemsTable">
        <table id="notesTable" border="1" style="margin-top: 10px; width: 100%;">
            <thead>
                <tr>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="text-align: center;">(Empty)</td>
                </tr>
            </tbody>
        </table>

        <table id="itemsTable" border="1" style="margin-top: 10px; width: 100%;">
            <thead>
                <tr>
                    <th>Attachments</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="text-align: center;">(Empty)</td>
                </tr>
            </tbody>
        </table>
        <table id="emailsTable" border="1" style="margin-top: 10px; width: 100%;">
            <thead>
                <tr>
                    <th>Emails</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="text-align: center;">(Empty)</td>
                </tr>
            </tbody>
        </table>
    </div>

    <button id="uploadAll">Upload All Attachments</button>
    <div id="selectedFolder">Example</div>
    <!--<div id="attachmentsDiv" style="display: none;"></div>-->


</template>
<template class="cardTemplate">
    <div class="card">
        <div class="timestamp tooltip">
            <span class="tooltiptext"></span>
        </div>
        <div class="status"></div>
        <div class="message"></div>
    </div>
</template>
<template class="errorTemplate">
    <style>
        .marvalsoftware-sharepoint-errors h3,
        .marvalsoftware-sharepoint-errors h4 {
            padding: 8px 0 8px 0;
        }

        .sharepointConfig > li {
            display: none;
        }
    </style>
    <div class="marvalsoftware-sharepoint-errors">
        <div class="title">
            <h3>Ensure all configuration settings are correct.</h3>
        </div>
        <div>
            <ul class="sharepointConfig">
                <li id="userAPIKey"> Organisation API Key </li>
            </ul>
            <h4></h4>
        </div>
    </div>
</template>
<template class="miscellaneousErrorsTemplate">
    <style>
        .marvalsoftware-sharepoint-errors h3,
        .marvalsoftware-sharepoint-errors h4 {
            padding: 8px 0 8px 0;
        }
    </style>
    <div class="marvalsoftware-sharepoint-errors">
        <div class="title">
            <h3>Error loading Sharepoint.</h3>
        </div>
        <div>
            <label></label>
        </div>
    </div>
</template>

<script type="text/javascript" src="msal-browser.min.js"></script>
<script>
    (function () {

        var MarvalSoftware = window.top.MarvalSoftware;
        var $ = window.top.$;
        var Sharepoint = null;
        let folderPaths = {}; //empty hashmap, we will have <folderid, path> so <string,string>
        var allPaths = new Map();

        let mockApiData = {
            value: [
                {
                    id: '1',
                    name: 'Documents',
                    folder: { childCount: 3 },
                    createdDateTime: '2024-01-15T10:30:00Z',
                    lastModifiedDateTime: '2024-01-20T14:22:00Z'
                },
                {
                    id: '2',
                    name: 'Images',
                    folder: { childCount: 5 },
                    createdDateTime: '2024-01-10T09:15:00Z',
                    lastModifiedDateTime: '2024-01-18T16:45:00Z'
                },
                {
                    id: '3',
                    name: 'Projects',
                    folder: { childCount: 2 },
                    createdDateTime: '2024-01-12T11:20:00Z',
                    lastModifiedDateTime: '2024-01-12T11:20:00Z'
                },
                {
                    id: '4',
                    name: 'Archives',
                    folder: { childCount: 1 },
                    createdDateTime: '2024-01-14T13:45:00Z',
                    lastModifiedDateTime: '2024-01-16T10:30:00Z'
                }
            ]
        };

        let mockSubfolderData = {
            '1': {
                value: [
                    {
                        id: '1-1',
                        name: 'Contracts',
                        folder: { childCount: 2 },
                        createdDateTime: '2024-01-15T10:30:00Z',
                        lastModifiedDateTime: '2024-01-20T14:22:00Z'
                    },
                    {
                        id: '1-2',
                        name: 'Legal',
                        folder: { childCount: 1 },
                        createdDateTime: '2024-01-16T09:15:00Z',
                        lastModifiedDateTime: '2024-01-16T09:15:00Z'
                    },
                    {
                        id: '1-3',
                        name: 'Templates',
                        folder: { childCount: 0 },
                        createdDateTime: '2024-01-17T14:20:00Z',
                        lastModifiedDateTime: '2024-01-17T14:20:00Z'
                    }
                ]
            },
            '2': {
                value: [
                    {
                        id: '2-1',
                        name: 'Marketing',
                        folder: { childCount: 3 },
                        createdDateTime: '2024-01-10T09:15:00Z',
                        lastModifiedDateTime: '2024-01-10T09:15:00Z'
                    },
                    {
                        id: '2-2',
                        name: 'Product',
                        folder: { childCount: 2 },
                        createdDateTime: '2024-01-11T15:30:00Z',
                        lastModifiedDateTime: '2024-01-11T15:30:00Z'
                    },
                    {
                        id: '2-3',
                        name: 'Screenshots',
                        folder: { childCount: 0 },
                        createdDateTime: '2024-01-12T11:45:00Z',
                        lastModifiedDateTime: '2024-01-12T11:45:00Z'
                    }
                ]
            }
        };

        // Global state
        let folderData = {};
        let expandedFolders = new Set();
        let loadingFolders = new Set();
        const icons = {
            chevronRight: `<svg class="chevron" viewBox="0 0 16 16">
    <path d="M6.22 3.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L9.94 8 6.22 4.28a.75.75 0 0 1 0-1.06Z"/>
</svg>`,
            folderClosed: `<svg class="folder-icon" viewBox="0 0 20 20">
    <path d="M2 6a2 2 0 0 1 2-2h5l2 2h5a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6Z"/>
</svg>`,
            folderOpen: `<svg class="folder-icon" viewBox="0 0 20 20">
    <path d="M2 6a2 2 0 0 1 2-2h5l2 2h5a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6Z" fill-opacity="0.7"/>
    <path d="M2 8h16v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8Z"/>
</svg>`,
            spinner: `<div class="spinner"></div>`
        };
        //window.toggleFolder = toggleFolder;
        MarvalSoftware.Plugins.define("marvalsoftware-plugins-sharepoint",
            {
                _element: null,
                _body: null,
                _refreshLink: null,
                _refreshElement: null,
                _cards: null,
                _card: null,
                _status: null,
                _message: null,
                _pages: null,
                _incidents: null,
                _createElement: null,
                _requestNumber: null,
                _requestID: null,
                _requestDescription: null,
                _contactEmail: null,
                _fullPluginPathHandler: null,
                _requestActionMessageID: null,
                _rowIndex: null,
                _attachmentName: null,
                _microsoftToken: null,
                _currentPath: null,
                _prevId:null,
                _currentSelectedFolderId: null,

               // Sharepoint: null,




                init: function () {
                    
                    const mockApiData = {
                        value: [
                            {
                                id: '1',
                                name: 'Documents',
                                folder: { childCount: 3 },
                                createdDateTime: '2024-01-15T10:30:00Z',
                                lastModifiedDateTime: '2024-01-20T14:22:00Z'
                            },
                            {
                                id: '2',
                                name: 'Images',
                                folder: { childCount: 5 },
                                createdDateTime: '2024-01-10T09:15:00Z',
                                lastModifiedDateTime: '2024-01-18T16:45:00Z'
                            },
                            {
                                id: '3',
                                name: 'Projects',
                                folder: { childCount: 2 },
                                createdDateTime: '2024-01-12T11:20:00Z',
                                lastModifiedDateTime: '2024-01-12T11:20:00Z'
                            },
                            {
                                id: '4',
                                name: 'Archives',
                                folder: { childCount: 1 },
                                createdDateTime: '2024-01-14T13:45:00Z',
                                lastModifiedDateTime: '2024-01-16T10:30:00Z'
                            }
                        ]
                    };

                    const mockSubfolderData = {
                        '1': {
                            value: [
                                {
                                    id: '1-1',
                                    name: 'Contracts',
                                    folder: { childCount: 2 },
                                    createdDateTime: '2024-01-15T10:30:00Z',
                                    lastModifiedDateTime: '2024-01-20T14:22:00Z'
                                },
                                {
                                    id: '1-2',
                                    name: 'Legal',
                                    folder: { childCount: 1 },
                                    createdDateTime: '2024-01-16T09:15:00Z',
                                    lastModifiedDateTime: '2024-01-16T09:15:00Z'
                                },
                                {
                                    id: '1-3',
                                    name: 'Templates',
                                    folder: { childCount: 0 },
                                    createdDateTime: '2024-01-17T14:20:00Z',
                                    lastModifiedDateTime: '2024-01-17T14:20:00Z'
                                }
                            ]
                        },
                        '2': {
                            value: [
                                {
                                    id: '2-1',
                                    name: 'Marketing',
                                    folder: { childCount: 3 },
                                    createdDateTime: '2024-01-10T09:15:00Z',
                                    lastModifiedDateTime: '2024-01-10T09:15:00Z'
                                },
                                {
                                    id: '2-2',
                                    name: 'Product',
                                    folder: { childCount: 2 },
                                    createdDateTime: '2024-01-11T15:30:00Z',
                                    lastModifiedDateTime: '2024-01-11T15:30:00Z'
                                },
                                {
                                    id: '2-3',
                                    name: 'Screenshots',
                                    folder: { childCount: 0 },
                                    createdDateTime: '2024-01-12T11:45:00Z',
                                    lastModifiedDateTime: '2024-01-12T11:45:00Z'
                                }
                            ]
                        }
                    };

                    Sharepoint = this;
                    Sharepoint._currentPath = "";
                    //window.Sharepoint = this;

                    this._sendInProgress = false; //we will use later to keep track of if we are sending a request
                    var HeaderText = $('#ctl00_ctl00_cph_entityHeaderText').text();
                    var currentUrl = window.top.location.href;
                    var currentHost = window.top.location.host;
                    _fullPluginPathHandler = "https://" + currentHost + Sharepoint._getPluginPath() + "handler/APIHandler.ashx";
                    //checkRequestActionMessageExists(); //should be /handler/APIHandler/ashx
                    //let hostString = await(await fetch(Sharepoint._getPluginPath() + "Handler.ashx?endpoint=ChatbotHostOverride")).text()
                    //let tenantId = await(await fetch(Sharepoint._getPluginPath() + "Handler.ashx?endpoint=TenantID")).text()
                    //let secret = await(await fetch(Sharepoint._getPluginPath() + "Handler.ashx?endpoint=SecretKey")).text()

                    if (currentUrl.includes("Plugin.aspx") && HeaderText == 'MarvalSoftware.Plugins.Sharepoint') {
                        checkRequestActionMessageExists();

                        function OpenInstallRequestRuleDialog() {
                            event.preventDefault();
                            $('#setupActionRuleModal').fadeIn(200);


                            var getWorkflowStatuses = fetch(_fullPluginPathHandler, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    action: "getWorkflowStatuses"
                                })
                            });
                            getWorkflowStatuses.then(async workflowStatuses => {
                                var jsonWorkflowStatusData = await workflowStatuses.json();
                                // console.log("Have workflows statuses as ", jsonWorkflowStatusData);
                                var $select = $('#workflowStatusDropdown');
                                $select.empty();
                                $select.append('<option value="">-- Select a Workflow Status --</option>');
                                jsonWorkflowStatusData.forEach(element => {
                                    $select.append($('<option>').val(element.Identifier).text(element.Name));
                                })
                            })
                            var getWorkflows = fetch(_fullPluginPathHandler, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    action: "getWorkflows"
                                })
                            });
                            getWorkflows.then(async workflows => {
                                var jsonworkflowData = await workflows.json();
                                //    console.log("Have workflow data as ", jsonworkflowData);
                                var $select = $('#workflowDropdown');
                                $select.empty();
                                $select.append('<option value="">-- Select a Workflow --</option>');
                                jsonworkflowData.forEach(element => {
                                    $select.append($('<option>').val(element.Identifier).text(element.Name));
                                    //     console.log("Have element ", element);
                                })
                            })
                        }

                        $('head').append(`
                        <style>
                        /* ✅ Steps */
.modal-steps {
  margin: 0;
  padding-left: 1.25rem;
  list-style: disc;
  color: #073f5c;
}
.modal-steps li {
  margin-bottom: .9rem;
}
.modal-steps a {
  color: #1696B7;
  text-decoration: underline;
}
.modal-steps a:hover {
  text-decoration: none;
}


.close {
  position: absolute;
  top: .75rem;
  right: .75rem;
  width: 32px;
  height: 32px;
  border: none;
  background: #1696B7;
  //color: #fff;
  font-size: 1.25rem;
  line-height: 1;
  border-radius: 50%;
  cursor: pointer;
  transition: background .2s ease;
}
.close:hover { background: #073f5c; }

/* 📈 Subtle pop-in */
@keyframes pop {
  0%   { transform: scale(.85); opacity: 0; }
  100% { transform: scale(1);   opacity: 1; }
}


.modal-content {
  display: flex;
  flex-direction: column;
  align-items: center;    /* horizontally center all direct children */
  text-align: center;      /* center text inside headings, list items, etc. */
  padding: 1.5rem;         /* optional, for a bit of breathing room */
}

.modal-content .modal-steps {
  padding: 0;
  list-style-position: inside; /* keep the bullets but centered */
  margin: 1rem 0;
}

.modal-content input,
.modal-content .hrefButton,
.modal-content .close {
  /* make sure buttons/inputs shrink to their contents */
  display: inline-block;
  margin: 0.5rem 0;
}
                        .headerColourChange {
    background: linear-gradient(to bottom right, #cbd6e2, #cbd6e2) !important;
    color: #00314a !important;
    font-size: 18px !important;
    font-family: 'Inter', 'Open Sans', sans-serif;
}
                        .modalBox {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: none;                 /* toggle with JS */
  place-items: center;
  background: rgba(7, 63, 92, .60);   /* #073f5c with 60 % opacity */
  backdrop-filter: blur(2px);
}

/* 🗂️  Content card -------------------------------------------------------- */
.modal-content {
  width: min(600px, 90%);
  
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,.25);
  padding: 2.5rem 2.25rem;
  animation: pop .35s ease;
  position: relative;
  font-family: "Segoe UI", Roboto, sans-serif;
}

/* 🎀 Header */
.modal-content h2 {
  margin: 0 0 1.25rem;
  font-size: 1.5rem;
  line-height: 1.2;
  color: #073f5c;
}
.modal-content h2 span {
  border-bottom: 3px solid #1696B7;
  padding-bottom: .25rem;
}
                            </style>`);
                        $('#ctl00_ctl00_cph_maintenance_pluginDetailsFieldSet').before(`<button class="hrefButton" id="requestActionMessageInstall">
  Install Request Action Message
</button>
<div id="requestActionMessageResponse"> </div>
<br>
<br>
<button class="hrefButton" id="actionRuleInstall">
  Open Request Action Rule Dialogue
</button>
<br>
<br>
<div id="setupActionRuleModal" class="modalBox">
  <div class="modal-content">
    <button class="close" title="Close">&times;</button>
<br>
    <h2><span>Install the Request Action Rule</span></h2>
    <br>
  <p>This section rule is used to determine the criteria for running the request action rule to create a new Sharepoint User.</p>
  <p>You can modify this later directly in the request action rule.</p>
  <br>
 <div class="form-group">
      <label for="workflowDropdown">Choose a workflow for your request action rule:</label><br>
      <select id="workflowDropdown">
        <option>Loading…</option>
      </select>
    </div>
<br>
    <div class="form-group">
      <label for="workflowStatusDropdown">Choose a workflow status for your request action rule:</label><br>
      <select id="workflowStatusDropdown" >
        <option>Loading…</option>
      </select>
    </div>
<br>
<br>
     <button class="hrefButton" id="InstallRequestActionRule">
        Install Request Action Rule
      </button>
       <div class="loadingSpinner" id="InstallRequestActionRuleSpinner" role="status" style="display:none" aria-label="Loading…"></div>
      <br><span id="InstalledRequestionActionRuleResponse"></span>
      <br>
      <ul class="modal-steps">
       <li>
      </li>
    </ul>
  </div>
</div>
`);
                        $('#ct100_overlay_id1').hide();
                        $('#ctl00_ctl00_cph_maintenance_worksWithMsm').removeClass('unsigned');
                        $('#ctl00_ctl00_cph_maintenance_worksWithMsm').addClass('signed');
                        console.log("button should be working");
                        window.top.document.getElementById("requestActionMessageInstall").onclick = downloadRequestActionMessage;
                        window.top.document.getElementById("actionRuleInstall").addEventListener("click", OpenInstallRequestRuleDialog);
                        window.top.document.getElementById("InstallRequestActionRule").onclick = InstallRequestActionRule;
                        async function InstallRequestActionRule() {
                            event.preventDefault();
                            $('#InstallRequestActionRule').attr('disabled', true);
                            $('#InstallRequestActionRuleSpinner').show();
                            $('#InstalledRequestionActionRuleResponse').empty();
                            $('#InstalledRequestionActionRuleResponse').css('color', 'green');
                            var Workflow = $("#workflowDropdown  option:selected").text();
                            var WorkflowStatus = $("#workflowStatusDropdown  option:selected").text();
                            if (Workflow === '-- Select a Workflow --' || WorkflowStatus === '-- Select a Workflow Status --') {
                                $('#InstalledRequestionActionRuleResponse').empty();
                                $('#InstallRequestActionRule').attr('disabled', false);
                                $('#InstalledRequestionActionRuleResponse').append('You must specify an attribute for each item');
                                $('#InstalledRequestionActionRuleResponse').css('color', 'red');
                                $('#InstallRequestActionRuleSpinner').hide();
                                return;
                            } else {

                                console.log("Selected is ", $("#workflowStatusDropdown option:selected"));
                                var WorkflowStatusId = $("#workflowStatusDropdown option:selected").val();
                                var WorkflowId = $("#workflowDropdown option:selected").val();
                                const encodedFullUrl = encodeURI(_fullPluginPathHandler);
                                //console.log("we ")

                                var createActionRule = await (await fetch(_fullPluginPathHandler, {
                                    "method": "POST",
                                    body: JSON.stringify({ actionMessageId: Sharepoint._requestActionMessageID, actionMessageURL: encodedFullUrl, WorkflowStatusId: WorkflowStatusId, WorkflowId: WorkflowId, action: "createActionRule" }),
                                    "headers": [["content-type", "application/json"]]
                                })).json();

                                $('#InstallRequestActionRuleSpinner').hide();
                                $('#InstallRequestActionRule').attr('disabled', false);
                                $('#InstalledRequestionActionRuleResponse').append(createActionRule.response);


                            }

                        }

                        function checkRequestActionMessageExists() {
                            var requestActionMessageName = "Sharepoint Integration Message - Automated";
                            var foundItem = false;
                            $.get('/MSM/RFP/Forms/RequestActionMessage.aspx', function (html) {
                                $(html).find('#ctl00_ctl00_ctl00_cph_existingEntitiesContentPlaceHolder_ExistingEntitiesList_loadMoreList_items a.item')

                                    .each(function () {

                                        if ($(this).attr('title') == requestActionMessageName) {

                                            foundItem = true;
                                            Sharepoint._requestActionMessageID = $(this).attr('href').match(/id=(\d+)$/)[1];
                                        }
                                        // console.log($(this).attr('search'));

                                    });
                                if (foundItem == true) {

                                    //  $('#isRequestActionMessageInstalled').append('You have a request action message in your list of request action messages <a href="/MSM/RFP/Forms/RequestActionMessage.aspx" >here</a>, you do not need to install it.');
                                    $('#pluginStatus').append('<br><span style="color:green">You have a request action message in your list of request action messages <a href="/MSM/RFP/Forms/RequestActionMessage.aspx" >here</a>, you do not need to install it.</span>');
                                    //   $('#isRequestActionMessageInstalled').css('color', 'green');
                                    //   $('#isRequestActionMessageInstalled').attr('')
                                } else {
                                    $('#pluginStatus').append('<span style="color:red"><br>You currently do not have the action message installed, click the button above to install it.<br>Once installed, it will appear in the list <a href="/MSM/RFP/Forms/RequestActionMessage.aspx">here</a> as an item called "Sharepoint Integration Message - Automated</span>"');
                                    // $('#isRequestActionMessageInstalled').append('You currently do not have the action message installed, click the button above to install it.<br>Once installed, it will appear in the list <a href="/MSM/RFP/Forms/RequestActionMessage.aspx">here</a> as an item called "Sharepoint Integration Message - Automated"');
                                    //  $('#isRequestActionMessageInstalled').css('color', 'red');
                                }
                            })
                                .fail(function () {
                                    // //  $select.empty()
                                    //     .append('<option disabled>Error loading list</option>');
                                });

                        }

                        async function toggleFolder(folderId) {
                            if (loadingFolders.has(folderId)) return;

                            const isExpanded = expandedFolders.has(folderId);

                            if (isExpanded) {
                                // Collapse folder
                                expandedFolders.delete(folderId);
                                const childrenContainer = document.querySelector(`[data-children-of="${folderId}"]`);
                                if (childrenContainer) {
                                    childrenContainer.remove();
                                }
                            } else {
                                // Expand folder
                                expandedFolders.add(folderId);

                                // Check if we need to load children
                                if (!folderData[folderId]) {
                                    loadingFolders.add(folderId);
                                    updateTreeItem(folderId);

                                    try {
                                        const response = await fetchChildren(folderId);
                                        folderData[folderId] = response.value;
                                        //if (response.ok) {
                                        //    renderChildren(folderId);
                                        //}
                                    } catch (error) {
                                        console.error('Error fetching children:', error);
                                        expandedFolders.delete(folderId);
                                    } finally {
                                        loadingFolders.delete(folderId);
                                    }
                                }

                                // Render children
                                renderChildren(folderId);
                            }

                            updateTreeItem(folderId);
                        }


                        async function getLatestPluginVersion() {

                            var url = "https://raw.githubusercontent.com/Marval-Global/SharepointPlugin/refs/heads/main/manifest.json";
                            var githubPluginVersion = await (await fetch(url)).json();
                            var pagePluginVersion = $('#ctl00_ctl00_cph_maintenance_version').text();

                            if (pagePluginVersion == githubPluginVersion.Version) {
                                $('#ctl00_ctl00_cph_maintenance_version').css("color", "green");
                                $('#ctl00_ctl00_cph_maintenance_version').css("font-weight", "bold"); _popup

                                $('#uptodatemessage').fadeIn(250);
                                setTimeout(() => {
                                    $('#uptodatemessage').fadeOut(1000);
                                }, 2000);
                            } else {
                                $('#ctl00_ctl00_cph_maintenance_version').css("color", "red");
                                $('#ctl00_ctl00_cph_maintenance_version').css("font-weight", "bold");
                                $('#ctl00_ctl00_cph_maintenance_version').append(' - Plugin requires updating. Click <a href="https://github.com/Marval-Global/SharepointPlugin/releases/latest/download/MarvalSoftware.Plugins.Sharepoint.zip">here</a> for the new version.');
                            }
                        }

                        $(document).ready(function () {

                            getLatestPluginVersion();
                        });
                    }
                    else if (!currentUrl.includes("Plugin.aspx")) {


                        //fetchSharePointSites();
                        //this._getAuth()
                        this._setUpQuickMenu();
                        this._requestNumber = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage().getRequestNumber();
                        this._requestID = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;
                        console.log(MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage());
                        this._requestDescription = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestDescription;
                        this._contactEmail = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage().getContactPreferredEmail();

                        //let foldersDropdown = document.getElementById("foldersDropdown");
                        //if (!foldersDropdown) {
                        //    console.log("does not exist");
                        //}

                        //document.getElementById("foldersDropdown").addEventListener("click", function (e) {
                        //    getAllFolders(e.target.value);
                        //});


                        addIconColumnFirst(this._getPluginPath() + "img/sharepoint_16.png", function ($row, index, eventTarget) {
                            Sharepoint._rowIndex = index + 1;
                            Sharepoint._attachmentName = $row.attr("title");
                            Sharepoint._popup(eventTarget);
                            //fetchSharePointSites();
                            
                            //alert(`Clicked row ${index + 1}`);
                            //Sharepoint._rowIndex = index;
                        });

                        //displayGroups();


                    }

                    async function getAllFolders(siteId) {
                        //Sharepoint._getAuth();
                        console.log("we are calling GETALLFOLDERS");
                        let apptoken = Sharepoint.microsoftToken;
                        console.log("apptokenhere is ", apptoken);
                        // console.log("apptoken is:", apptoken);
                        try {
                            //const clientIdUrl = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=ClientID"

                            //  console.log("apptoken is:", apptoken);
                            const response = await fetch(_fullPluginPathHandler + "?endpoint=getAllFolders", {
                                method: "POST",
                                "headers": [["content-type", "application/json"]],
                                body: JSON.stringify({
                                    "apptoken": apptoken,
                                    "siteId": siteId
                                })
                                // headers:{'apptoken':apptoken}

                            });
                            let foldersJson = await response.json(); //response promise

                            //console.log("All folders are: ", foldersJson);

                            //console.log("we should be appending folders now");
                            //let $dropdown = $('#foldersDropdown');
                            //if ($dropdown) {
                            //    console.log("folders dropdown does exist");
                            //}
                            //$dropdown.empty();
                            //$dropdown.append('<option value = "">-- Select a Folder --</option>');

                            //sitesJson.value.forEach(site => {
                            //    //console.log("folder here is", site);
                            //    $dropdown.append($('<option>').val(site.id).text(site.name));
                            //});
                            //console.log("appending should finish!");

                            //; //in theory should have all our sites if response is correct


                        } catch (error) {
                            console.log("Error fetching sites: ", error);
                        }
                    }

                    async function getMicrosoftAccessToken() {
                        try {
                            // Get the Client ID from your SharePoint handler or hardcode it here
                            const clientIdUrl = _fullPluginPathHandler + "?endpoint=ClientID"; // adjust as needed

                            const clientId = await (await fetch(clientIdUrl)).text();
                            console.log("client id is:", clientId);

                            const msalInstance = await msal.createStandardPublicClientApplication({
                                auth: {
                                    clientId: clientId,
                                    authority: "https://login.microsoftonline.com/common"
                                }
                            });

                            const loginRequest = {
                                scopes: ["https://graph.microsoft.com/.default"]
                            };

                            const response = await msalInstance.loginPopup(loginRequest);

                            console.log("Logged in successfully, access token:", response.accessToken);
                            Sharepoint._microsoftToken = response.accessToken;
                            return response.accessToken;

                        } catch (err) {
                            console.error("MSAL login failed:", err);
                            throw err;
                        }
                    }


                    async function fetchSharePointSites() {
                        //Sharepoint._getAuth();
                        console.log("we are calling fetchsharepointsites");
                        let apptoken = await getMicrosoftAccessToken();
                       //console.log("apptoken is:", apptoken);
                        try {
                            //const clientIdUrl = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=ClientID"

                            //  console.log("apptoken is:", apptoken);
                            const response = await fetch(_fullPluginPathHandler + "?endpoint=getSites", {
                                method: "POST",
                                "headers": [["content-type", "application/json"]],
                                body: JSON.stringify({
                                    "apptoken": apptoken,
                                    endpoint: "getSites"
                                })
                                // headers:{'apptoken':apptoken}

                            });
                            let sitesJson = await response.json()

                            console.log("Sharepoint sites are: ", sitesJson);

                            console.log("we should be appending sites now");
                            let $dropdown = $('#sitesDropdown');
                            if ($dropdown) {
                                console.log("sites dropdown does exist");
                            }
                            $dropdown.empty();
                            $dropdown.append('<option value = "">-- Select a Site --</option>');

                            sitesJson.value.forEach(site => {
                                //console.log("site here is", site);
                                $dropdown.append($('<option>').val(site.id).text(site.name || site.webUrl));
                            });
                            console.log("appending should finish!");

                            ; //in theory should have all our sites if response is correct


                        } catch (error) {
                            console.log("Error fetching sites: ", error);
                        }
                    }

                    


                    function addIconColumnFirst(imageSrc, onClickCallback) {
                        const $table = $('.attachments table.related');
                        const $theadRow = $table.find('thead tr');
                        const $tbodyRows = $table.find('tbody tr').not('.noAttachmentsMessage');

                        // 1. Add an empty <th> at the start
                        $theadRow.prepend(`<th class="icon-column"></th>`);

                        // 2. Add an icon <td> at the start of each row
                        $tbodyRows.each(function (index) {
                            const $row = $(this);
                            const $icon = $(`
            <td class="icon-column">
                <a href="#" class="icon-link" title="Open SharePoint">
                    <img src="${imageSrc}" alt="icon" style="width:16px; height:16px; cursor:pointer;" />
                </a>
            </td>
        `);

                            // Optional: attach click handler if needed now
                            if (typeof onClickCallback === 'function') {
                                $icon.find('a.icon-link').on('click', function (e) {
                                    e.preventDefault();
                                    onClickCallback($row, index, e.target);
                                });
                            }

                            $row.prepend($icon);
                        });
                    }



                    async function downloadRequestActionMessage() { //should be an async function
                        event.preventDefault();
                        console.log("we are calling download request action message");
                        var actionMessageText = `

@{
    var lastNote = (Model.Notes != null && Model.Notes.Count > 0)
        ? Model.Notes[Model.Notes.Count - 1]
        : null;

var requestDescription = @Model.Description;
var fullMessage = "";
}

@if (lastNote != null)
{
fullMessage=  "<b>Description:</b><br> " + requestDescription+ "<br> <b>Last Note:</b><br> " + @lastNote.Content + "<br><b>Last Note Created On:</b><br> "+@lastNote.Created + "<br> <b>Last Note Author</b><br> " + @lastNote.Author + " <br> <b>Service Name:</b><br>"+@Model.Service.Name + "<br>";

}


{
                           "Identifier": @Model.Identifier,

                           "ContactName": "@Model.LastUpdatedBy.Name.GivenName @Model.LastUpdatedBy.Name.FamilyName ",
                           "Email": "@Model.PreferredNotification.Address",
                        "message": "@fullMessage",
"serviceName": "@Model.Service.Name",
"action": "SendSharepointMessage"


                        }

                            `;
                        var currentUrl = window.top.location.host;
                        var pluginPathHandler = "https://" + currentUrl + Sharepoint._getPluginPath() + "handler/ApiHandler.ashx";
                        //$('#InstallRequestActionMessage').attr('disabled', true);

                        console.log("actionmsgtext: ", actionMessageText);
                        var snippetFile = await (await fetch(pluginPathHandler, {
                            "method": "POST",
                            body: JSON.stringify({ action: "createActionMessage", actionMessageText: actionMessageText }),
                            "headers": [["content-type", "application/json"]]
                        })).json();
                        console.log("response is: ", snippetFile);
                        $('#InstallRequestActionMessageSpinner').hide();
                        $('#InstallRequestActionMessage').attr('disabled', false);
                        $('#requestActionMessageResponse').append(snippetFile.response);
                        $('#requestActionMessageResponse').css('color', 'green');
                        //  console.log("Have snippet as ", snippetFile);
                    }




                },
                _fetchSharePointSites: async function() {
            //Sharepoint._getAuth();
            console.log("we are calling fetchsharepointsites");
                    //let apptoken = await getMicrosoftAccessToken();
                    let apptoken = await this._getMicrosoftAccessToken2();
            //console.log("apptoken is:", apptoken);
            try {
                //const clientIdUrl = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=ClientID"

                //  console.log("apptoken is:", apptoken);
                const response = await fetch(_fullPluginPathHandler + "?endpoint=getSites", {
                    method: "POST",
                    "headers": [["content-type", "application/json"]],
                    body: JSON.stringify({
                        "apptoken": apptoken,
                        endpoint: "getSites"
                    })
                    // headers:{'apptoken':apptoken}

                });
                let sitesJson = await response.json()

        console.log("Sharepoint sites are: ", sitesJson);

                console.log("we should be appending sites now");
                let $dropdown = $('#sitesDropdown');
                if($dropdown) {
                    console.log("sites dropdown does exist");
                }
        $dropdown.empty();
                $dropdown.append('<option value = "">-- Select a Site --</option>');

                sitesJson.value.forEach(site => {
                    //console.log("site here is", site);
                    $dropdown.append($('<option>').val(site.id).text(site.name || site.webUrl));
                });
                console.log("appending should finish!");

        ; //in theory should have all our sites if response is correct


    } catch (error) {
        console.log("Error fetching sites: ", error);
    }
},
                _getAuth: async function () {

                    let hostString = await (await fetch(Sharepoint._getPluginPath() + "handler/APIHandler.ashx?endpoint=ChatbotHostOverride")).text()
                    let tenantId = await (await fetch(Sharepoint._getPluginPath() + "handler/APIHandler.ashx?endpoint=TenantID")).text()
                    let secret = await (await fetch(Sharepoint._getPluginPath() + "handler/APIHandler.ashx?endpoint=SecretKey")).text()




                    var url = Sharepoint._getPluginPath() + "handler/APIHandler.ashx?endpoint=ClientID"

                    //var id = await (await fetch(url)).text()

                    const msalInstance = await msal.createStandardPublicClientApplication({
                        auth: {
                            clientId: "b6a84976-d3bc-4f7d-ae42-a50472a64116",
                            authority: "https://login.microsoftonline.com/common/oauth2/v2.0/authorize"
                        },
                    });

                    var loginRequest = {
                        scopes: ["https://graph.microsoft.com/.default"]
                    };

                    try {
                        var response = await msalInstance.loginPopup(loginRequest);

                        try {
                            const result = await (await fetch("https://graph.microsoft.com/v1.0/users?$filter=userPrincipalName eq '" + Sharepoint._contactEmail + "'", {

                                method: "GET",
                                headers: new Headers({
                                    "Authorization": "Bearer " + response.accessToken,
                                })
                            })).json()

                            console.log(response.accessToken);

                            if (result.value.length < 1) {
                                throw Error("Search for contact returned no results.")
                            } else {

                            }

                        } catch (err) {
                            $("#SharepointError").remove();
                            $("#SharepointPopup").append("<div id='SharepointError'><br><p style='color: red;'>Unable to find a Sharepoint contact for " + Sharepoint._contactEmail + "</p></div>")
                            console.error("Sharepoint search error:\n", err)
                            $("*").remove(".chatbot-container")
                        }

                    } catch (err) {
                        $("#SharepointError").remove();
                        $("#SharepointPopup").append("<div id='SharepointError'><br><p style='color: red;'>Unable to authenticate with Microsoft</p></div>")
                        $("*").remove(".chatbot-container")
                        console.error("MS Auth error:\n", err)
                    }


                },

                _uploadToSharepoint: function (sender, e) {
                    e.preventDefault();

                    let sitesDropdown = $("#sitesDropdown");
                    //let foldersDropdown = $("#foldersDropdown");

                    var payload = {
                        message: formulatedMessage,
                        action: "SendSharepointMessage",
                        //siteId: sitesDropdown.val(),
                        // folderId: foldersDropdown.val() //jquery is .val()
                    }
                    //if (window.top.document.getElementById("CheckBox").checked) {
                    //    var formulatedMessage = messageText + " under request number: " + this._requestNumber + ", request ID: " + this._requestID + ", the request description: " + description + ", from :" + email;
                    //    payload = {
                    //        message: formulatedMessage,
                    //        action: "SendSharepointMessage"
                    //    }
                    //} else {//not checked
                    //    payload = {
                    //        message: messageText,
                    //        action: "SendSharepointMessage"
                    //    }
                    //}
                    //console.log("We are here");



                    $.ajax({
                        type: "POST",
                        url: this._getPluginPath() + "handler/ApiHandler.ashx?action=SendSharepointMessage",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: JSON.stringify(payload),
                        success: function (result) {
                            if (Object.keys(result).length > 0) {
                                this._errorPopup(result);
                            }
                            else {
                                this._popup();
                            }
                        }.bind(this)
                    });
                },

                _getPluginPath: function () {
                    return this.attributes["data-pluginpath"].value;
                },

                _getPluginId: function () {
                    return this.attributes["data-pluginid"].value;
                },

                _getPluginCulture: function () {
                    return this.attributes["data-pluginculture"].value;
                },

                _getString: function (key, formatObject) {
                    if (MarvalSoftware.Plugins.PluginResourceManager) {
                        return MarvalSoftware.Plugins.PluginResourceManager.getInstance()
                            .getString(this._getPluginId(), key, this._getPluginCulture(), formatObject);
                    } else {
                        return key;
                    }
                },
                //_updateButtonVisual() {
                //    if (window.top.document.getElementById("message").value != "" && window.top.document.getElementById("groupsDropdown").value != "") {
                //        window.top.document.getElementById("sendMessage").style.backgroundColor = "green";
                //        window.top.document.getElementById("sendMessage").disabled = false;
                //    } else {
                //        window.top.document.getElementById("sendMessage").style.backgroundColor = "gray";
                //        window.top.document.getElementById("sendMessage").disabled = true;
                //    }
                //},

                _getMicrosoftAccessToken2 : async function() {
            try {
                // Get the Client ID from your SharePoint handler or hardcode it here
                const clientIdUrl = _fullPluginPathHandler + "?endpoint=ClientID"; // adjust as needed

                const clientId = await(await fetch(clientIdUrl)).text();
                console.log("client id is:", clientId);

                const msalInstance = await msal.createStandardPublicClientApplication({
                    auth: {
                        clientId: clientId,
                        authority: "https://login.microsoftonline.com/common"
                    }
                });

                const loginRequest = {
                    scopes: ["https://graph.microsoft.com/.default"]
                };

                const response = await msalInstance.loginPopup(loginRequest);

                console.log("Logged in successfully, access token:", response.accessToken);
                Sharepoint._microsoftToken = response.accessToken;
                return response.accessToken;

            } catch(err) {
                console.error("MSAL login failed:", err);
                throw err;
            }
        },

                _renderElement: function () {
                    

                    var eventManager = MarvalSoftware.UI.Dom.EventManager.getInstance();
                    var template = document.querySelector("template").content;
                    this._element = window.top.document.importNode(template, true);
                    //this._uploadMessage = this._element.querySelector("#uploadFile");
                    //this._foldersElement = this._element.querySelector("#foldersDropdown");
                    //eventManager.addHandler(this.folderSelected, "input", this._, this);

                    this._uploadButton = this._element.querySelector("#uploadAll");
                    if (this._uploadButton) {
                        console.log("upload all button does exist");
                    }
                    eventManager.addHandler(this._uploadButton, "click", this._uploadAllAttachments
                        
                    , this); //should be uploading all now
                    

                    // this._body = this._element.querySelector("textarea");
                    this._cards = this._element.querySelector(".cards");
                    //this._trimWhiteSpaces(this._body);
                    //var eventManager = MarvalSoftware.UI.Dom.EventManager.getInstance();
                    //this._sendMessageButton = this._element.querySelector("#sendMessage");
                    //eventManager.addHandler(this._sendMessageButton, "click", this._postMessage, this);
                    this._createElement = this._element.querySelector(".action-buttons > button");
                    this._refreshLink = this._element.querySelector("a");

                    //this.messageInput = this._element.querySelector("#message");
                    //eventManager.addHandler(this.messageInput, "input", this._updateButtonVisual, this);

                    //this.groupSelected = this._element.querySelector("#groupsDropdown");
                    //eventManager.addHandler(this.groupSelected, "input", this._updateButtonVisual, this);

                    this.folderBtn = this._element.querySelector("#createFolder");
                    eventManager.addHandler(this.folderBtn, "click", this._createFolder, this);

                    this.siteSelected = this._element.querySelector("#sitesDropdown");
                    eventManager.addHandler(this.siteSelected, "input", this._printSiteId, this);
                    eventManager.addHandler(this.siteSelected, "input", function (e) {
                        this._getAllFolders(e.value);
                        //this._getAllFolders(e.value, "test:");
                        $("#treeContainer").css("display", "show");
                        this._renderTree();//call when we seelect a site
                        console.log("we should be calling get all folders twice and getting the response ");

                    }, this); //should be appending all folders now
                    //let creating = browser.windows.create(
                    //    //createData            // optional object
                    //)


                    //this.expandButton = this._element.querySelector("#expand-button2");
                    //eventManager.addHandler(this.expandButton, "click", this._toggleFolder(), this);

                    this.appendChild(this._element);
                },
                //_consoleLogFolder: function () {
                //    let res = await Sharepoint._getAllFolders();
                //},

                _trimWhiteSpaces: function (element) {
                    var value = element.value;
                    value = value.replace(/(^\s*)|(\s*$)/gi, "");
                    value = value.replace(/[ ]{2,}/gi, " ");
                    value = value.replace(/\n /, "\n");
                    element.value = value;
                }, _getAllNotes: async function (sender, e) {
                    //preventDefault(); //prevent default everytime
                    let sitesDropdown = $("#sitesDropdown"); // need table
                    let notesTable = $("#notesTable tbody");

                    try {
                        console.log(" getting all attachments ");
                        let reqId = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;
                        let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=getAllNotes&reqId=" + reqId;
                        console.log("we are going to this attachment url ", url)

                        console.log("url is", url);
                        let result = await fetch(url, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8"
                            },
                        });
                        if (!result.ok) {
                            let errorText = await result.text();
                            throw new Error(`HTTP error ${result.status}: ${errorText}`);
                        }

                        let notes = await result.json();
                        console.log("notes feedback", notes);
                        // Clear existing rows (including the "(Empty)" row)
                        let notesDiv = window.top.document.getElementById("notesDiv");
                        if (notesDiv) {
                            console.log("notes div exists and we are appending to it", notesDiv);
                        }

                        // Clear old content
                        notesDiv.innerHTML = "";

                        // Loop through notes and create elements
                        notes.collection.items.forEach(note => {
                            let noteInfo = note.entity.data;
                            let fileName = `${noteInfo.type} ${noteInfo.createdOn} ${noteInfo.author.name}`;
                            let summary = noteInfo.contentSummary;

                            // Create a container for each note
                            let container = document.createElement("div");
                            container.className = "note-item";
                            container.style.marginBottom = "12px";
                            container.style.padding = "6px 0";
                            container.style.borderBottom = "1px solid #ddd";

                            // Create the checkbox
                            let checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.name = "selectAttachment";
                            checkbox.value = fileName;
                            checkbox.setAttribute("data-attachment-id", noteInfo.id);
                            //summaryDiv.className = "note-summary"; // <-- add this
                            checkbox.style.marginRight = "8px";

                            // Create the label
                            let label = document.createElement("label");
                            label.textContent = fileName;
                            label.style.fontWeight = "bold";

                            // Create a summary element
                            let summaryDiv = document.createElement("div");
                            summaryDiv.textContent = summary;
                            summaryDiv.style.marginLeft = "26px"; // align under label text
                            summaryDiv.style.color = "#555";
                            summaryDiv.style.fontSize = "0.9em";
                            summaryDiv.className = "note-summary"; // <-- add this

                            // Append to container
                            container.appendChild(checkbox);
                            container.appendChild(label);
                            container.appendChild(summaryDiv);

                            // Append container to notes div
                            notesDiv.appendChild(container);
                        });


                    } catch (ex) {
                        console.error("we have error", ex);
                    }

                },
                _getAllAttachments: async function (sender, e) {
                    //preventDefault(); //prevent default everytime
                    let sitesDropdown = $("#sitesDropdown"); // need table
                    let itemsTable = $("#itemsTable tbody");

                    try {
                        console.log(" getting all attachments ");
                        let reqId = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;                 
                        let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=getAllAttachments&reqId=" + reqId;
                        console.log("we are going to this attachment url ", url)

                        console.log("url is", url);
                        let result = await fetch(url, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8"
                            },
                        });
                        if (!result.ok) {
                            let errorText = await result.text();
                            throw new Error(`HTTP error ${result.status}: ${errorText}`);
                        }

                        let attachment = await result.json();
                        console.log("attachmentS feedback", attachment);
                        // Clear existing rows (including the "(Empty)" row)
                        let attachmentsDiv = window.top.document.getElementById("attachmentsDiv");
                        if (attachmentsDiv) {
                            console.log("we found attachments div and we are now appending");
                        }
                        attachmentsDiv.innerHTML = ""; // clear previous

                        // Add new attachment elements
                        attachment.collection.items.forEach(attachmentItem => {
                            let fileName = attachmentItem.entity.data.fileName;
                            let id = attachmentItem.entity.data.id;

                            // Create container for the item
                            let container = document.createElement("div");
                            container.className = "attachment-item";
                            container.style.marginBottom = "8px";

                            // Create checkbox
                            let checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.name = "selectAttachment";
                            checkbox.value = fileName;
                            checkbox.setAttribute("data-attachment-id", id);

                            // Create label or file name text
                            let label = document.createElement("label");
                            label.textContent = fileName;
                            label.style.marginLeft = "8px";

                            // Append to container
                            container.appendChild(checkbox);
                            container.appendChild(label);

                            // Append container to the div
                            attachmentsDiv.appendChild(container);
                            console.log("appended attachments now");
                        });


                    } catch (ex) {
                        console.error("we have error", ex);
                    }

                },
                _uploadAllAttachments: async function (sender, e) {
                    //e.preventDefault();
                    console.log("we are calling upload all attachments");
                    //e.preventDefault();
                    let sitesDropdown = $("#sitesDropdown");
                    //let foldersDropdown = $("#foldersDropdown");
                    let reqId = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;
                    let siteId = sitesDropdown.val();
                    //let folderId = foldersDropdown.find("option:selected").text(); // or `.val()` if you're using value instead
                    // Find all checked checkboxes in the attachments column
                    let checkedBoxes = $("#attachmentsDiv input[type='checkbox']:checked");
                    let notesBoxes = $("#notesDiv input[type='checkbox']:checked");
                    if (checkedBoxes.length === 0 && notesBoxes.length === 0) {
                        console.warn("No attachments selected.");
                        alert("Please select at least one attachment to upload.");
                        return;
                    }

                    //let folderPath = folderPaths[Sharepoint._currentSelectedFolderId] || "";
                    let folderPath = this._currentPath;
                    console.log("folder path in upallat ius ", folderPath);


                    for (let notebox of notesBoxes) {
                        let attachmentName = $(notebox).val(); // file name stored in value
                        let identifier = notebox.dataset.attachmentId; //checkboxes store the attachment data
                        let summaryText = $(notebox).closest(".note-item").find(".note-summary").text().trim();


                        console.log("Uploading attachment:", summaryText);

                        //let folderPath = folderPaths[Sharepoint._currentSelectedFolderId] || "";

                        let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=uploadNote&reqId=" + reqId + "&identifier=" + identifier + "&attachmentName=" + summaryText;
                        //should be uploading all notes
                        console.log("we are uploading notes to this url " + url);
                        let payload = {
                            microsoftToken: Sharepoint._microsoftToken,
                            siteId: siteId,
                            folderId: folderPath
                        };

                        try {
                            let result = await fetch(url, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json; charset=utf-8"
                                },
                                body: JSON.stringify(payload)
                            });

                            if (!result.ok) {
                                let errorText = await result.text();
                                throw new Error(`Error uploading "${attachmentName}": ${result.status} - ${errorText}`);
                            }

                            let response = await result.json();
                            console.log(`Uploaded: ${attachmentName}`, response);
                            $("#successMessage")
                                .text("Successfully uploaded notes")
                                .fadeIn("slow")      // Fade in
                                .delay(2000)         // Wait 2 seconds
                                .fadeOut("slow");    // Then fade out

                        } catch (ex) {
                            console.error("Upload error for", attachmentName, ex);
                            $("#successMessage")
                                .text("Error could not upload notes")
                                .fadeIn("slow")      // Fade in
                                .delay(2000)         // Wait 2 seconds
                                .fadeOut("slow"); 
                        }
                    }

                    for (let checkbox of checkedBoxes) {
                        let attachmentName = $(checkbox).val(); // file name stored in value
                        let identifier = checkbox.dataset.attachmentId; //checkboxes store the attachment data

                        console.log("Uploading attachment:", attachmentName);

                        let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=getAttachment&reqId=" + reqId + "&identifier="+identifier+ "&attachmentName=" + attachmentName;
                        //should change backend getAttachment name to something better
                        console.log("we are uploading files to this url " + url);
                        let payload = {
                            microsoftToken: Sharepoint._microsoftToken,
                            siteId: siteId,
                            folderId: folderPath
                        };

                        try {
                            let result = await fetch(url, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json; charset=utf-8"
                                },
                                body: JSON.stringify(payload)
                            });

                            if (!result.ok) {
                                let errorText = await result.text();
                                throw new Error(`Error uploading "${attachmentName}": ${result.status} - ${errorText}`);
                            }

                            let response = await result.json();
                            console.log(`Uploaded: ${attachmentName}`, response);
                            $("#successMessage")
                                .text("Successfully uploaded attachments")
                                .fadeIn("slow")      // Fade in
                                .delay(2000)         // Wait 2 seconds
                                .fadeOut("slow");    // Then fade out

                        } catch (ex) {
                            console.error("Upload error for", attachmentName, ex);
                            $("#successMessage")
                                .text("Error could not upload attachments")
                                .fadeIn("slow")      // Fade in
                                .delay(2000)         // Wait 2 seconds
                                .fadeOut("slow"); 
                        }
                    }

                    alert("Upload complete.");
                },

                
                _getAttachment: async function (sender, e, identifier = null) {
                    e.preventDefault(); //prevent default everytime
                    let sitesDropdown = $("#sitesDropdown");
                    //let foldersDropdown = $("#foldersDropdown");

                    try {
                        //console.log("req id is", reqId, "identifier is ", this._rowIndex);
                        console.log(" we are calling get attachment now");
                        let reqId = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;
                        console.log("req id is", reqId, "identifier is ", this._rowIndex);
                        let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=getAttachment&reqId=" + reqId + "&identifier=" + this._rowIndex + "&attachmentName=" + Sharepoint._attachmentName;
                        console.log("we are going to this attachment url ", url);
                        //console.log("site id is", sitesDropdown.val(), "folderid is", foldersDropdown.find("option:selected").text());

                        let payLoad = {
                            microsoftToken: Sharepoint._microsoftToken,
                            siteId: sitesDropdown.val(),
                            folderId: foldersDropdown.find("option:selected").text()

                        }
                        console.log("url is", url);
                        let result = await fetch(url, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8"
                            },
                            body: JSON.stringify(payLoad)
                        });
                        if (!result.ok) {
                            let errorText = await result.text();
                            throw new Error(`HTTP error ${result.status}: ${errorText}`);
                        }

                        let attachment = await result.json();
                        console.log("attachment feedback", attachment);

                        //return attachment;

                    } catch (ex) {
                        console.error("we have error", ex);
                    }

                },
                _getAllEmails: async function () {
                    try {
                        console.log(" getting all emails ");
                        let reqId = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;
                        let url = "https://localhost/MSM/RFP/Forms/RequestEmailAuditViewer.aspx?id=" + reqId;
                        console.log("we are going to this email url ", url)

                        console.log("url is", url);
                        let result = await fetch(url, {
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8"
                            },
                        });
                        if (!result.ok) {
                            let errorText = await result.text();
                            throw new Error(`HTTP error ${result.status}: ${errorText}`);
                        }

                        let emails = await result.text();
                        let emailsHtml = $(emails); // Parse the HTML string into jQuery object
                        let emailsBody = emailsHtml.find("#ctl00_cph_grid_body"); // Find the main body
                        let targetCells = emailsBody.find(".cell-default.cell-body"); // Find the nested class elements

                        console.log("Found target cells:", targetCells);

                        //console.log("emails feedback", emails);
                        //// Clear existing rows (including the "(Empty)" row)
                        //let notesDiv = window.top.document.getElementById("emailsDiv");
                        //if (notesDiv) {
                        //    console.log("notes div exists and we are appending to it", notesDiv);
                        //}



                        //// Clear old content
                        //notesDiv.innerHTML = "";

                        //// Loop through notes and create elements
                        //notes.collection.items.forEach(note => {
                        //    let noteInfo = note.entity.data;
                        //    let fileName = `${noteInfo.type} ${noteInfo.createdOn} ${noteInfo.author.name}`;
                        //    let summary = noteInfo.contentSummary;

                        //    // Create a container for each note
                        //    let container = document.createElement("div");
                        //    container.className = "note-item";
                        //    container.style.marginBottom = "12px";
                        //    container.style.padding = "6px 0";
                        //    container.style.borderBottom = "1px solid #ddd";

                        //    // Create the checkbox
                        //    let checkbox = document.createElement("input");
                        //    checkbox.type = "checkbox";
                        //    checkbox.name = "selectAttachment";
                        //    checkbox.value = fileName;
                        //    checkbox.setAttribute("data-attachment-id", noteInfo.id);
                        //    //summaryDiv.className = "note-summary"; // <-- add this
                        //    checkbox.style.marginRight = "8px";

                        //    // Create the label
                        //    let label = document.createElement("label");
                        //    label.textContent = fileName;
                        //    label.style.fontWeight = "bold";

                        //    // Create a summary element
                        //    let summaryDiv = document.createElement("div");
                        //    summaryDiv.textContent = summary;
                        //    summaryDiv.style.marginLeft = "26px"; // align under label text
                        //    summaryDiv.style.color = "#555";
                        //    summaryDiv.style.fontSize = "0.9em";
                        //    summaryDiv.className = "note-summary"; // <-- add this

                        //    // Append to container
                        //    container.appendChild(checkbox);
                        //    container.appendChild(label);
                        //    container.appendChild(summaryDiv);

                        //    // Append container to notes div
                        //    notesDiv.appendChild(container);
                        //});


                    } catch (ex) {
                        console.error("we have error", ex);
                    }
                },
                _createFolder: async function (sender, e) {
                    e.preventDefault(); //prevent default everytime
                    let sitesDropdown = $("#sitesDropdown");
                    //let foldersDropdown = $("#foldersDropdown");

                    try {
                        //console.log("req id is", reqId, "identifier is ", this._rowIndex);
                        console.log(" we are calling get create folder now");
                        let reqId = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getPage()._requestId;
                        console.log("req id is", reqId, "identifier is ", this._rowIndex);
                        console.log("creating folder with current path ", Sharepoint._currentPath);
                        let name = Sharepoint._currentPath.replace(/\//g, '');
                        let url = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=createFolder&reqId=" + reqId + "&identifier=" + this._rowIndex + "&attachmentName=" + name;
                        console.log("we are going to this create url ", url);
                        //console.log("site id is", sitesDropdown.val(), "folderid is", foldersDropdown.find("option:selected").text());

                        let payLoad = {
                            microsoftToken: Sharepoint._microsoftToken,
                            siteId: sitesDropdown.val(),
                            folderId: Sharepoint._currentPath

                        }
                        console.log("url is", url);
                        const result = await fetch(url, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8"
                            },
                            body: JSON.stringify(payLoad)
                        });
                        if (!result.ok) {
                            const errorText = await result.text();
                            throw new Error(`HTTP error ${result.status}: ${errorText}`);
                            $("#successMessage")
                                .text("Error did not create folder")
                                .fadeIn("slow")      // Fade in
                                .delay(2000)         // Wait 2 seconds
                                .fadeOut("slow"); 
                        }

                        $("#successMessage")
                            .text("Successfully created folder")
                            .fadeIn("slow")      // Fade in
                            .delay(2000)         // Wait 2 seconds
                            .fadeOut("slow"); 

                        const attachment = await result.json();
                        console.log("attachment feedback", attachment);
                        this._renderTree();
                        //let res = await Sharepoint._fetchChildren(Sharepoint._currentSelectedFolderId);
                        //Sharepoint._renderChildren(Sharepoint._currentSelectedFolderId);
                      //  //simply re render after folder creation

                        //return attachment;

                    } catch (ex) {
                        $("#successMessage")
                            .text("error did not create folder")
                            .fadeIn("slow")      // Fade in
                            .delay(2000)         // Wait 2 seconds
                            .fadeOut("slow"); 
                        console.error("we have error", ex);
                    }

                }, _formatDate: function (dateString)
                {
            if(!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        },

                _fetchChildren: async function (folderId) {
                    // Use the path from the map, which is set in _renderChildren
                    const folderPath = folderPaths[folderId] || "";
                    //console.log("folder id here fo")
                    console.log("the fetch children folder pth is ", folderPath, " with folder id ", folderId);

                    // Get the selected siteId
                    let siteId = window.top.document.getElementById('sitesDropdown').value;

                    // Call the real API
                    const foldersJson = await Sharepoint._getAllFolders(siteId, folderPath);
                    console.log("fetch children results are ", foldersJson);

                    // Only return folders
                    return {
                        value: (foldersJson && foldersJson.value)
                            ? foldersJson.value.filter(item => item.folder)
                            : []
                    };
                },

        // SVG icons
//        const icons = {
//            chevronRight: `<svg class="chevron" viewBox="0 0 16 16">
//    <path d="M6.22 3.22a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L9.94 8 6.22 4.28a.75.75 0 0 1 0-1.06Z"/>
//</svg>`,
//            folderClosed: `<svg class="folder-icon" viewBox="0 0 20 20">
//    <path d="M2 6a2 2 0 0 1 2-2h5l2 2h5a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6Z"/>
//</svg>`,
//            folderOpen: `<svg class="folder-icon" viewBox="0 0 20 20">
//    <path d="M2 6a2 2 0 0 1 2-2h5l2 2h5a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6Z" fill-opacity="0.7"/>
//    <path d="M2 8h16v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8Z"/>
//</svg>`,
//            spinner: `<div class="spinner"></div>`
//        };

                // Create tree item element

        //function createTreeItem(item, level = 0) 
                _createTreeItem: function (item, level) {
                    //console.log("we are at create tree item");
                    const self = this;

                    const isExpanded = expandedFolders.has(item.id);
                    console.log("is expanded is ", isExpanded)

                    const isLoading = loadingFolders.has(item.id);
                    console.log("is loading is ", isLoading);

                    const itemElement = document.createElement('div');
                    itemElement.className = 'tree-item';
                    itemElement.style.paddingLeft = `${level * 20 + 8}px`;
                    itemElement.dataset.itemId = item.id;

                    // Controls container
                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'tree-controls';

                    if (isLoading) {
                        // Spinner
                        controlsDiv.innerHTML = icons.spinner;
                    } else {
                        // Expand/collapse button
                        const expandBtn = document.createElement('button');
                        expandBtn.className = 'expand-button2';
                        expandBtn.innerHTML = icons.chevronRight;
                        if (isExpanded) {
                            expandBtn.querySelector('.chevron').classList.add('expanded');//tyr to add class this way
                        }
                        $(".expand-button2").on('click', function () {
                            console.log("clicked button")
                            $(this).closest('.folder-name').css("color", 'red');
                        })
                        expandBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            console.log("clicked button")
                            $(e).closest('.folder-name').css("color", "red");
                            self._toggleFolder(item.id, expandBtn, e);//toggle folder onclick
                        });
                        controlsDiv.appendChild(expandBtn);
                    }

                    // Folder icon
                    const folderIcon = document.createElement('span');
                    folderIcon.innerHTML = isExpanded ? icons.folderOpen : icons.folderClosed;
                    controlsDiv.appendChild(folderIcon);

                    // Compose the rest
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'folder-name';
                    nameSpan.textContent = item.name;

                    const countHtml = item.folder && item.folder.childCount > 0 ?
                        `<span class="item-count">${item.folder.childCount} items</span>` : '';

                    const dateHtml = `<span class="last-modified">${Sharepoint._formatDate(item.lastModifiedDateTime)}</span>`;

                    itemElement.appendChild(controlsDiv);
                    itemElement.appendChild(nameSpan);
                    if (countHtml) itemElement.insertAdjacentHTML('beforeend', countHtml);
                    itemElement.insertAdjacentHTML('beforeend', dateHtml);

                    // Hover effects
                    itemElement.addEventListener('mouseenter', () => itemElement.classList.add('hovered'));
                    itemElement.addEventListener('mouseleave', () => itemElement.classList.remove('hovered'));

                    // Add click handler to the whole tree item
                    itemElement.addEventListener('click', function (e) {
                        // Prevent double handling if the expand/collapse button was clicked
                        if (e.target.closest('.expand-button2')) return;

                        // Set current path and update UI
                        Sharepoint._prevId = Sharepoint._currentSelectedFolderId;
                        Sharepoint._currentSelectedFolderId = item.id;
                        Sharepoint._currentPath = folderPaths[item.id];

                        // Update the selected folder display
                        $("#selectedFolder").text(Sharepoint._currentPath);

                        // Optionally, update the selected style for the folder name
                        $('.folder-name').removeClass('selected');
                        nameSpan.classList.add('selected');
                    });

                    return itemElement;
                }, _collapseDescendants: function (folderId) {
                    expandedFolders.delete(folderId);
                    delete folderPaths[folderId];

                    const childrenContainer = window.top.document.querySelector(`[data-children-of="${folderId}"]`);
                    if (childrenContainer) {
                        const childFolderElements = childrenContainer.querySelectorAll('.tree-item');
                        childFolderElements.forEach(childEl => {
                            const childId = childEl.dataset.itemId;
                            if (expandedFolders.has(childId)) {
                                Sharepoint._collapseDescendants(childId);
                            }
                        });
                        childrenContainer.remove();
                    }
                },

                // Toggle folder expand/collapse
                _toggleFolder: async function (folderId, sender, e) {
                    e.preventDefault();
                    
                    Sharepoint._prevId = this._currentSelectedFolderId; //so when we go to new node, old path will be cur path before update
                    Sharepoint._currentSelectedFolderId = folderId;//set cur id
                    Sharepoint._currentPath = folderPaths[folderId];//set cur path

                    let selectedFolderDiv = $("#selectedFolder");
                    selectedFolderDiv.text(Sharepoint._currentPath);//show it
                    //probably put this in is not expanded
                    //window.top.document.querySelectorAll(".folder-icon.selected").forEach(el => {
                    //    el.classList.remove('selected');
                    //});

                    const selectedItem = $(`[data-item-id="${folderId}"] .folder-name`).css("color", 'red');
                    console.log("selected item is ", selectedItem.text())
                    //$(selectedItem).css("color","red");
                    if (selectedItem.length) {
                        selectedItem.addClass("selected");
                        selectedItem.css("fill", "red"); // Use "fill" for SVG color
                    }

                    if (loadingFolders.has(folderId)) return;

                    const isExpanded = expandedFolders.has(folderId);

                    if (isExpanded) {
                        Sharepoint._collapseDescendants(folderId);
                    } else {
                        expandedFolders.add(folderId);//we should be expanding it
                        console.log("we are adding folder id ", folderId, " to expanded: ");

                        // Only fetch children if not already loaded
                        if (!folderData[folderId]) {
                            loadingFolders.add(folderId);
                            Sharepoint._updateTreeItem(folderId);

                            try {
                                const response = await Sharepoint._fetchChildren(folderId);
                                folderData[folderId] = response.value;//should 
                            } catch (error) {
                                console.error('Error fetching children:', error);
                                expandedFolders.delete(folderId);
                            } finally {
                                loadingFolders.delete(folderId);
                            }
                        }

                        // Only render children if not already rendered
                        const existingContainer = window.top.document.querySelector(`[data-children-of="${folderId}"]`);
                        if (!existingContainer) {
                            Sharepoint._renderChildren(folderId);
                        }
                    }
                    Sharepoint._updateTreeItem(folderId);
                },

                _updateTreeItem: function (itemId) {
                    const itemElement = window.top.document.querySelector(`[data-item-id="${itemId}"]`);
                    if (!itemElement) {
                        console.log("No itemElement found for", itemId);
                        return;
                    }

                    const item = Sharepoint._findItemById(itemId);
                    if (!item) {
                        console.log("No item found for", itemId);
                        return;
                    }

                    const level = parseInt(itemElement.style.paddingLeft) / 20 - 0.4;
                    const newElement = Sharepoint._createTreeItem(item, level);

                    // Debug log
                    console.log("Replacing element for", itemId, "at level", level, "parent", itemElement.parentNode);

                    itemElement.parentNode.replaceChild(newElement, itemElement);
                },

                // Find item by ID in the data structure

                _findItemById: function (itemId) {
                    // Search root folders
                    for (const item of (folderData['root'] || [])) {
                        if (item.id === itemId) return item;
                    }
                    // Search all loaded children
                    for (const children of Object.values(folderData)) {
                        for (const item of children) {
                            if (item.id === itemId) return item;
                        }
                    }
                    return null;
                },

        // Render children of a folder
                _renderChildren: function (folderId) {
                    //console.log("we are rendering children now");
            const children = folderData[folderId];
            if (!children || children.length === 0) return;

                    const parentElement = window.top.document.querySelector(`[data-item-id="${folderId}"]`);
                    console.log("Parent element for", folderId, parentElement);
            if (!parentElement) return;

            // Remove existing children container
            const existingContainer = window.top.document.querySelector(`[data-children-of="${folderId}"]`);
            if (existingContainer) {
                existingContainer.remove();
            }

            // Create new children container
            const childrenContainer = document.createElement('div');
            childrenContainer.className = 'children';
            childrenContainer.dataset.childrenOf = folderId;

            // Calculate level
            const parentLevel = parseInt(parentElement.style.paddingLeft) / 20 - 0.4;
                    const childLevel = parentLevel + 1;

                    const parentPath = folderPaths[folderId] || "";



                    // Add child items
            console.log("childeren is ", children)
                    children.forEach(child => {
                        folderPaths[child.id] = parentPath ? parentPath + "/" + child.name : child.name;
                        console.log("this childs path is ", folderPaths[child.id], " with id of ", child.id)

                const childElement = Sharepoint._createTreeItem(child, childLevel);
                childrenContainer.appendChild(childElement);
            });

            // Insert after parent
            parentElement.insertAdjacentElement('afterend', childrenContainer);
        },

                _renderTree: async function () {
                    const container = window.top.document.getElementById('treeContent');
                    container.innerHTML = '';

                    // Get the selected siteId from the dropdown
                    let siteId = window.top.document.getElementById('sitesDropdown').value;
                    if (!siteId) {
                        container.innerHTML = '<div>Please select a site.</div>';
                        return;
                    }

                    // Fetch folders from backend
                    console.log("we are calling with siteId ", siteId, " and folder path (should be null or empty for root):", null);
                    let foldersJson = await this._getAllFolders(siteId, null); //should be null here

                    if (foldersJson && foldersJson.value && Array.isArray(foldersJson.value)) {
                        // Only show items that are folders (have a .folder property)
                        folderData['root'] = foldersJson.value.filter(item => item.folder);//remember to add root folders to folder data
                        
                        foldersJson.value
                            .filter(item => item.folder) // Only folders
                            .forEach(item => {
                                folderPaths[item.id] = item.name;//in initial render of tree we should set all paths first
                                const itemElement = Sharepoint._createTreeItem(item, 0);
                                container.appendChild(itemElement);
                            });
                    } else {
                        container.innerHTML = '<div>No folders found.</div>';
                    }
                },
                _renderAttachmentsWindow: function () {
                    let attachmentDiv = window.top.document.getElementById('attachmentsDiv');
                    let notesDiv = document.createElement("div");
                    notesDiv.innerText = "div 2";
                    let emailsDiv = document.createElement('div');
                    let $attachmentsDiv = $("#attachmentsDiv")
                    $attachmentsDiv.append("testingf1211");
                    $attachmentsDiv.append(notesDiv);
                    $attachmentsDiv.append(emailsDiv);
                    if (attachmentDiv) {
                        //attachmentDiv

                        //attachmentDiv.style.display = "block";
                        console.log("we found attachments div", attachmentDiv);
                    } else {
                        console.log("we cannot find attachments div")
                    }
                },

        // Initialize the tree
        //renderTree();

        // Make toggleFolder available globally
        //window.toggleFolder = toggleFolder;

                _popup: function (eventTarget) {
                    console.log(eventTarget);
                    console.log(document.location.search);
                    let url = (new URLSearchParams(window.top.location.search)).get("id");
                    console.log(url);
                    //let atcDiv = window.top.document.getElementById('attachmentsDiv');
                    //atcDiv.style.display ="block"

                    let itemsDiv = document.createElement("div");
                    //itemsDiv.innerHTML = ("test");
                    itemsDiv.id = "itemsDiv";
                    //creating our subdivs
                    let notesDiv = document.createElement("div");
                    notesDiv.id = "notesDiv";

                    
                    let attachmentsDiv = document.createElement("div");
                    attachmentsDiv.id = "attachmentsDiv";
                    let emailsDiv = document.createElement("div");
                    emailsDiv.id = "emailsDiv";

                    let uploadButtonTwo = document.createElement("button");
                    uploadButtonTwo.id = "uploadButtonTwo";
                    uploadButtonTwo.innerHTML = "upload all";
                    uploadButtonTwo.onclick = function (e) {
                        e.preventDefault();
                        Sharepoint._uploadAllAttachments(e);
                    };

                    itemsDiv.appendChild(notesDiv);
                    itemsDiv.appendChild(emailsDiv);
                    itemsDiv.appendChild(attachmentsDiv);
                    itemsDiv.appendChild(uploadButtonTwo);

                    console.log("items div is ", itemsDiv);


                    //let notesDiv = document.createElement("div");
                    //notesDiv.innerHtml = ("");
                    //let emailsDiv = document.createElement("div");
                    //emailsDiv.innerHtml = ("");

                    //let eventElement = eventTarget);
                    if (!this._pluginWindow) {
                        this._pluginWindow = new MarvalSoftware.UI.Window({
                            appendToElement: window.top.document.getElementById("aspnetForm"),
                            title: "Sharepoint",
                            height: 1000,
                            width: 1000,
                            minHeight: 700,
                            minWidth: 432,
                            isResizable: true,
                            isMaximizable: true,
                            bodyElement: this

                        }

                        );
                        //this._notesWindow = new MarvalSoftware.UI.Window({
                        //    appendToElement: window.top.document.getElementById("aspnetForm"),
                        //    title: "Notes",
                        //    height: 300,
                        //    width: 300,
                        //    minHeight: 300,
                        //    minWidth: 300,
                        //    isResizable: true,
                        //    isMaximizable: true,
                        //    bodyElement: notesDiv

                        //})
                        //this._emailsWindow = new MarvalSoftware.UI.Window({
                        //    appendToElement: window.top.document.getElementById("aspnetForm"),
                        //    title: "Emails",
                        //    height: 300,
                        //    width: 300,
                        //    minHeight: 300,
                        //    minWidth: 300,
                        //    isResizable: true,
                        //    isMaximizable: true,
                        //    bodyElement: emailsDiv

                        //})
                        this._attachmentsWindow = new MarvalSoftware.UI.Window({
                            appendToElement: window.top.document.getElementById("aspnetForm"),
                            title: "Attachments",
                            height: 800,
                            width: 800,
                            minHeight: 300,
                            minWidth: 300,
                            isResizable: true,
                            isMaximizable: true,
                            bodyElement: itemsDiv,
                            //position: absolute,
                            top: 500,
                            left: 500,
                            //position: relative,

                        }

                        );
                        this._renderElement();
                        //this._getAllAttachments();
                        //this._getAllNotes();
                        this._fetchSharePointSites();
                        //this._renderAttachmentsWindow();

                        if (eventTarget != undefined) {
                            console.log(eventTarget.parentElement.parentElement.nextSibling.innerText);
                        }
                    }
                    //this._resetPopUpValues();
                    if (!this._pluginWindow.isVisible()) {
                        this._pluginWindow.centerToViewport();
                    }
                    //this._attachmentsWindow.style(100, 100);
                    //this._notesWindow.setPosition(200, 200);
                    //this._emailsWindow.setPosition(300, 300);

                    //this._attachmentsWindow.style.position = "relative";

                    //this._attachmentDiv.style.position = "relative";
                    //this._attachmentsWindow.append();
                   this._attachmentsWindow.centerToViewport();

                    this._pluginWindow.show();
                    this._attachmentsWindow.show();
                    this._getAllEmails();

                    setTimeout(200);
                    //this._renderAttachmentsWindow();
                    this._getAllNotes();
                    this._getAllAttachments();
                    //this._notesWindow.show();
                    //this._emailsWindow.show();

                   
                    //set position
                    
                    $('.window .content .header').eq(0).addClass('headerColourChange');
                    $('.window .content .header').eq(1).addClass('LinkedProjectsHeader');
                },

                _errorPopup: function (result) {
                    var errorTemplate = document.querySelector('.errorTemplate').content;
                    var errorMessages = window.top.document.importNode(errorTemplate, true);
                    if (result) {
                        for (var item in result) {
                            var id = "#" + item;
                            errorMessages.querySelector(id).style.display = "block";
                        }
                        errorMessages.querySelector('div > h3').textContent = this._getString("@@SharepointErrorConfigurationTitle");
                        errorMessages.querySelector('div > h4').textContent = this._getString("@@SharepointErrorConfigurationFooter");
                    }
                    MarvalSoftware.UI.MessageBox.show(
                        this._getString("@@SharepointErrorPopupTitle"),
                        errorMessages,
                        MarvalSoftware.UI.MessageBox.Types.ERROR,
                        [MarvalSoftware.UI.MessageBox.Buttons.OK],
                        MarvalSoftware.UI.MessageBox.Buttons.OK,
                        450
                    );
                },

                _miscellaneousErrorPopup: function (result) {
                    var miscellaneousErrorsTemplate = document.querySelector('.miscellaneousErrorsTemplate').content;
                    var errorMessages = window.top.document.importNode(miscellaneousErrorsTemplate, true);
                    if (result) {
                        console.log("We have an error ", result);
                        errorMessages.querySelector('div > label').textContent = result.responseText;
                    }
                    MarvalSoftware.UI.MessageBox.show(
                        this._getString("@@SharepointErrorPopupTitle"),
                        errorMessages,
                        MarvalSoftware.UI.MessageBox.Types.ERROR,
                        [MarvalSoftware.UI.MessageBox.Buttons.OK],
                        MarvalSoftware.UI.MessageBox.Buttons.OK,
                        450
                    );
                },

                _addCard: function (results) {
                    this._clearCards();
                    if (!results.incident_updates || results.incident_updates.length == 0) {
                        var label = document.createElement("h3")
                        label.textContent = this._getString("@@SharepointNoItems");
                        label.align = "center";
                        label.style.position = "relative";
                        label.style.top = "150px";
                        label.style.color = "#808080";
                        this._cards.appendChild(label);
                        return;
                    }

                    for (var i = 0; i < results.incident_updates.length; i++) {
                        this._resetCard()
                        var status = results.incident_updates[i].status;
                        var createdOn = results.incident_updates[i].display_at;
                        this.timestamp.firstElementChild.innerHTML = new Date(createdOn).toDateString() + " " + this._formattedTime(createdOn);
                        this.timestamp.innerHTML += this._formattedDate(createdOn).toUpperCase();
                        this.status.innerText = status.charAt(0).toUpperCase() + status.slice(1);
                        this.message.innerText = results.incident_updates[i].body;
                        this._cards.appendChild(this.card);
                    }

                    this._cards.scrollTop = 0
                },

                _clearCards: function () {
                    while (this._cards.firstChild) {
                        this._cards.removeChild(this._cards.firstChild);
                    }
                },

                _resetCard: function () {
                    var cardTemplate = document.querySelector(".cardTemplate").content;
                    var element = window.top.document.importNode(cardTemplate, true);
                    this.card = element.querySelector(".card");
                    this.timestamp = element.querySelector(".card > .timestamp");
                    this.status = element.querySelector(".card > .status");
                    this.message = element.querySelector(".card > .message");
                },

                _refreshCards: function () {
                    this._getAllIncindentUpdates();
                    this._enableOrDisableIncidentsOption();
                },

                _resetPopUpValues: function () {
                    this._pages.selectedIndex = "0";
                    this._body.value = "";
                    this._clearIncidents();
                },

                _clearIncidents: function () {
                    for (var i = this._incidents.options.length - 1; i >= 0; i--) {
                        this._incidents.remove(i);
                    }

                    var incident = document.createElement("option")
                    incident.id = 0;
                    incident.value = "";
                    this._incidents.add(incident)
                    this._refreshCards();
                },

                _formattedDate: function (updatedBy) {
                    var minute = 60 * 1000;
                    var hour = minute * 60;
                    var day = hour * 24;
                    var month = day * 30;
                    var year = day * 365;
                    var elapsed = new Date().getTime() - new Date(updatedBy).getTime();
                    if (elapsed < minute) {
                        return "< 1 min ago";
                    }
                    else if (elapsed < hour) {
                        var calculatedHours = Math.round(elapsed / minute);
                        return calculatedHours > 1 ? calculatedHours + " minutes ago" : calculatedHours + " min ago";
                    }
                    else if (elapsed < day) {
                        var calculatedDays = Math.round(elapsed / hour);
                        return calculatedDays > 1 ? calculatedDays + " hours ago" : calculatedDays + " hour ago";
                    }
                    else if (elapsed < month) {
                        var calculatedMonths = Math.round(elapsed / day);
                        return calculatedMonths > 1 ? calculatedMonths + " days ago" : calculatedMonths + " day ago";
                    }
                    else if (elapsed < year) {
                        var calculatedMonths = Math.round(elapsed / month);
                        return calculatedMonths > 1 ? calculatedMonths + " months ago" : calculatedMonths + " month ago";
                    }
                    else {
                        var calculatedYears = Math.round(elapsed / year);
                        return calculatedYears > 1 ? calculatedYears + " years ago" : calculatedYears + " year ago";
                    }
                },

                _addZero: function (i) {
                    if (i < 10) {
                        i = "0" + i;
                    }
                    return i;
                },

                _formattedTime: function (value) {
                    var date = new Date(value);
                    return this._addZero(date.getHours()) + ":" + this._addZero(date.getMinutes());
                },

                _setUpQuickMenu: function () {
                    var styleElement = window.top.document.createElement("style");
                    window.top.document.body.appendChild(styleElement);
                    styleElement.sheet.insertRule(".marvalSoftware-sharepoint-quick-menu-item { background-image: url(" + this._getPluginPath() + "img/sharepoint_32.png); }", 0);

                    var quickMenuId = window.top.document.querySelector(".quickMenu").id;
                    var quickMenu = MarvalSoftware.UI.Controls.ScriptManager.getInstance().getControl(quickMenuId);
                    quickMenu.addMenuItem({
                        Identifier: "marvalSoftware-sharepoint",
                        Label: this._getString("@@PluginDisplayname"),
                        HRef: "javascript:void(0);",
                        CssClass: "marvalSoftware-sharepoint-quick-menu-item"
                    });
                    quickMenu.onMenuItemClicked.subscribe(function (sender, e) {
                        if (e.menuItem.getIdentifier() === "marvalSoftware-sharepoint") {
                            //window.open("", "_blank", "width=800,height=600")
                            this._popup();
                        }
                    },
                        this);
                },

                _preRequisiteCheck: function (sender, e) {

                    $.ajax({
                        type: "POST",
                        url: this._getPluginPath() + "handler/ApiHandler.ashx?action=PreRequisiteCheck",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (result) {
                            if (Object.keys(result).length > 0) {
                                this._errorPopup(result);
                            }
                            else {
                                this._popup();
                            }
                        }.bind(this)
                    });
                }, _postMessage: function (sender, e) {
                    e.preventDefault();
                    var messageText = $('#message').val();
                    let email = this._contactEmail ? this._contactEmail : " No email defined";
                    let description = window.top.document.getElementById("ctl00_cph_description").value;
                    var payload = {};
                    //if (window.top.document.getElementById("CheckBox").checked) {
                    //    var formulatedMessage = messageText + " under request number: " + this._requestNumber + ", request ID: " + this._requestID + ", the request description: " + description + ", from :" + email;
                    //    payload = {
                    //        message: formulatedMessage,
                    //        action: "SendSharepointMessage"
                    //    }
                    //} else {//not checked
                    //    payload = {
                    //        message: messageText,
                    //        action: "SendSharepointMessage"
                    //    }
                    //}
                    console.log("We are here");



                    $.ajax({
                        type: "POST",
                        url: this._getPluginPath() + "handler/ApiHandler.ashx?action=SendSharepointMessage",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: JSON.stringify(payload),
                        success: function (result) {
                            if (Object.keys(result).length > 0) {
                                this._errorPopup(result);
                            }
                            else {
                                this._popup();
                            }
                        }.bind(this)
                    });
                },


                _getAllPageIncindents: function () {
                    $.ajax({
                        type: "POST",
                        url: this._getPluginPath() + "handler/ApiHandler.ashx?action=GetAllPageIncidents&pageId=" + this._pages.options[this._pages.selectedIndex].value,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (results) {
                            if (results) {
                                this._clearIncidents();
                                for (var i = 0; i < results.length; i++) {
                                    var incident = document.createElement("option");
                                    incident.value = results[i].id;
                                    incident.text = results[i].name;
                                    this._incidents.add(incident);
                                }
                            }
                        }.bind(this),
                        error: function (results) {
                            this._clearIncidents();
                        }.bind(this)
                    });
                },

                /** */

                _getAllFolders: async function (siteId, folderPath = null) {
                    //Sharepoint._getAuth();
                    console.log("we are calling GETALLFOLDERS");
                    let apptoken = Sharepoint._microsoftToken;
                    if (folderPath) {
                        console.log("folder path in get all folders ", folderPath);
                    } else {
                        console.log("folder path is still null")
                    }
                    

                    //console.log("apptoken is:", apptoken);
                    try {
                        //const clientIdUrl = this._getPluginPath() + "handler/APIHandler.ashx?endpoint=ClientID"

                        //  console.log("apptoken is:", apptoken);
                        const response = await fetch(_fullPluginPathHandler + "?endpoint=getAllFolders", {
                            method: "POST",
                            "headers": [["content-type", "application/json"]],
                            body: JSON.stringify({
                                "apptoken": apptoken,
                                "siteId": siteId,
                                "folderPath": folderPath
                            })
                            // headers:{'apptoken':apptoken}

                        });
                        let foldersJson = await response.json(); //response promise

                        //console.log("All folders are: ", foldersJson);

                        //console.log("we should be appending folders now");
                        //let $dropdown = $('#foldersDropdown');
                        //if ($dropdown) {
                        //    console.log("folders dropdown does exist");
                        //}
                        //$dropdown.empty();
                        //$dropdown.append('<option value = "">-- Select a Folder --</option>');

                        //foldersJson.value.forEach(site => {
                        //  //  console.log("folder here is", site);
                        //    $dropdown.append($('<option>').val(site.id).text(site.name));
                        //});
                        console.log("appending should finish!");

                        //in theory should have all our sites if response is correct
                        return foldersJson;//so we can use it later


                    } catch (error) {
                        console.log("Error fetching sites: ", error);
                    }
                },
                _printSiteId: function (e) {
                    console.log("site id ", e.value);
                },

                _getAllIncindentUpdates: function () {
                    var pageId = this._pages.options[this._pages.selectedIndex].value;
                    var incidentNumber = this._incidents.options[this._incidents.selectedIndex].value;
                    this._showSpinner();
                    if (incidentNumber) {
                        $.ajax({
                            type: "POST",
                            url: this._getPluginPath() + "handler/ApiHandler.ashx?action=GetAllIncidentUpdates&pageId=" + pageId + "&incidentNumber=" + incidentNumber,
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            success: function (results) {
                                if (results) {
                                    this._addCard(results);
                                }
                            }.bind(this),
                            error: function (result) {
                                if (result) {
                                    this._addCard(result);
                                }
                            }.bind(this)
                        });
                    }
                    this._enableOrDisableMessageTextArea();
                    this._hideSpinner();

                },

                _getAllPages: function (sender, e) {
                    $.ajax({
                        type: "POST",
                        url: this._getPluginPath() + "handler/ApiHandler.ashx?action=GetAllPages",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (results) {
                            if (results) {
                                for (var i = 0; i < results.length; i++) {
                                    var page = document.createElement("option");
                                    page.value = results[i].id;
                                    page.text = results[i].name;
                                    this._pages.add(page);
                                }
                            }
                        }.bind(this)
                    });
                },

                _update: function (value) {
                    this._sendInProgress = true;
                    this._enableOrDisableSubmit();//as send is in progress, we need to disable the button

                    var data = { incident: { body: value } };
                    var pageId = this._pages.options[this._pages.selectedIndex].value;
                    var incidentNumber = this._incidents.options[this._incidents.selectedIndex].value;


                    $.ajax({
                        type: "POST",
                        url: this._getPluginPath() + "handler/ApiHandler.ashx?action=UpdateSharepointIncident&pageId=" + pageId + "&incidentNumber=" + incidentNumber,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: JSON.stringify(data),
                        success: function (result, textStatus, xhr) {


                            if (result.error) {
                                this._miscellaneousErrorPopup({ "responseText": xhr.status + " " + result.error.join(", ") });
                            } else {
                                this._getAllIncindentUpdates();
                                this._body.value = "";
                            }
                            this._sendInProgress = false;
                            this._enableOrDisableSubmit();
                            sendBtn.disabled = false;

                        }.bind(this),
                        error: function (xhr) {

                            let statusCode = xhr.status;
                            let message = xhr.responseText;

                            try {
                                var parsed = JSON.parse(message);
                                if (parsed.error && Array.isArray(parsed.error)) {
                                    message = parsed.error.join(", ")
                                }
                            } catch (e) {

                            }
                            this._miscellaneousErrorPopup({
                                "responseText": statusCode + " " + message
                            })
                            this._sendInProgress = false;
                            this._enableOrDisableSubmit();
                            sendBtn.disabled = false;

                        }.bind(this)
                    });
                },


                _enableOrDisableIncidentsOption: function (sender, e) {
                    if (this._pages.selectedIndex > 0) {
                        this._incidents.removeAttribute('disabled');
                    } else {
                        this._incidents.setAttribute('disabled', '');
                    }
                },


                _enableOrDisableMessageTextArea: function (sender, e) {
                    if (this._pages.selectedIndex > 0 && this._incidents.selectedIndex > 0) {
                        this._body.removeAttribute('disabled');
                    } else {
                        this._body.setAttribute('disabled', '');
                    }
                }
            });
    })();
</script>
